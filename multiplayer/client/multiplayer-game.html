<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Risk - Multiplayer Game</title>
  <link rel="icon" type="image/x-icon" href="../../favicon.ico">
  
  <!-- Original game styles -->
  <link rel="stylesheet" href="../../css/combat-system.css" />
  <link rel="stylesheet" href="../../css/combat-animations.css" />
  <link rel="stylesheet" href="../../css/combat-testing.css" />
  <link rel="stylesheet" href="../../css/army-counts.css" />
  
  <!-- Multiplayer UI styles -->
  <link rel="stylesheet" href="multiplayer-ui.css" />
  
  <style>
    /* Hide original single-player controls if needed */
    .single-player-only {
      display: none !important;
    }
  </style>
</head>
<body>
  <!-- Loading Screen -->
  <div id="mp-loading-screen" style="
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 20000;
  ">
    <div style="text-align: center; color: #ffd700;">
      <div class="waiting-spinner" style="margin: 0 auto 20px;"></div>
      <h2 style="font-size: 2em; margin-bottom: 10px;">Connecting to Game...</h2>
      <p id="loading-message">Initializing multiplayer session</p>
    </div>
  </div>

  <!-- Load original game in iframe -->
  <iframe 
    id="game-frame" 
    src="../../game.html" 
    style="
      width: 100%;
      height: 100vh;
      border: none;
      display: none;
    "
  ></iframe>

  <!-- Socket.IO Client -->
  <script src="http://localhost:3000/socket.io/socket.io.js"></script>
  
  <!-- Multiplayer modules -->
  <script src="MultiplayerClient.js"></script>
  <script src="MultiplayerGameAdapter.js"></script>
  
  <script>
    /**
     * Multiplayer Game Initialization
     * Connects to server and syncs game state
     */

    const urlParams = new URLSearchParams(window.location.search);
    const sessionId = urlParams.get('session');
    
    if (!sessionId) {
      alert('No session ID provided!');
      window.location.href = 'lobby.html';
    }

    // Initialize multiplayer client (auto-detect server URL)
    const client = new MultiplayerClient();
    const userId = client.getUserId();
    const playerName = localStorage.getItem('risk_playerName') || 'Player';

    let gameFrame;
    let gameWindow;
    let adapter;

    async function initializeMultiplayerGame() {
      try {
        updateLoadingMessage('Connecting to server...');
        
        // Connect to server
        await client.connect();
        
        updateLoadingMessage('Joining session...');
        
        // Join session
        await client.joinSession(sessionId, playerName);
        
        updateLoadingMessage('Loading game...');
        
        // Setup frame communication
        gameFrame = document.getElementById('game-frame');
        
        gameFrame.onload = async () => {
          try {
            gameWindow = gameFrame.contentWindow;
            
            updateLoadingMessage('Syncing game state...');
            
            // Wait for game to initialize
            await waitForGameReady();
            
            updateLoadingMessage('Setting up multiplayer...');
            
            // Initialize multiplayer adapter
            adapter = new gameWindow.MultiplayerGameAdapter(
              client,
              gameWindow.gameState,
              gameWindow.turnManager
            );
            
            // Inject multiplayer UI components
            injectMultiplayerUI();
            
            await adapter.initialize();
            
            // Hide loading screen
            hideLoadingScreen();
            
            console.log('✅ Multiplayer game ready!');
          } catch (error) {
            console.error('Frame initialization error:', error);
            showError('Failed to initialize game: ' + error.message);
          }
        };
        
      } catch (error) {
        console.error('Initialization error:', error);
        showError('Failed to connect: ' + error.message);
      }
    }

    function waitForGameReady() {
      return new Promise((resolve, reject) => {
        let attempts = 0;
        const maxAttempts = 50;
        
        const checkReady = setInterval(() => {
          attempts++;
          
          if (gameWindow.gameState && gameWindow.turnManager) {
            clearInterval(checkReady);
            resolve();
          } else if (attempts >= maxAttempts) {
            clearInterval(checkReady);
            reject(new Error('Game initialization timeout'));
          }
        }, 200);
      });
    }

    function injectMultiplayerUI() {
      const gameDoc = gameFrame.contentDocument || gameFrame.contentWindow.document;
      
      // Inject styles
      const styleLink = gameDoc.createElement('link');
      styleLink.rel = 'stylesheet';
      styleLink.href = '/multiplayer/client/multiplayer-ui.css';
      gameDoc.head.appendChild(styleLink);
      
      // Inject adapter script
      const adapterScript = gameDoc.createElement('script');
      adapterScript.src = '/multiplayer/client/MultiplayerGameAdapter.js';
      gameDoc.body.appendChild(adapterScript);
      
      // Make client available in game window
      gameWindow.multiplayerClient = client;
      gameWindow.multiplayerAdapter = adapter;
      
      console.log('✅ Multiplayer UI injected');
    }

    function updateLoadingMessage(message) {
      const elem = document.getElementById('loading-message');
      if (elem) {
        elem.textContent = message;
      }
    }

    function hideLoadingScreen() {
      const loadingScreen = document.getElementById('mp-loading-screen');
      if (loadingScreen) {
        loadingScreen.style.display = 'none';
      }
      gameFrame.style.display = 'block';
    }

    function showError(message) {
      const loadingScreen = document.getElementById('mp-loading-screen');
      if (loadingScreen) {
        loadingScreen.innerHTML = `
          <div style="text-align: center; color: #f44336;">
            <h2 style="font-size: 2em; margin-bottom: 20px;">❌ Error</h2>
            <p style="font-size: 1.2em; margin-bottom: 30px;">${message}</p>
            <button onclick="window.location.href='lobby.html'" style="
              padding: 15px 30px;
              font-size: 1.2em;
              background: #ffd700;
              color: #1a1a2e;
              border: none;
              border-radius: 10px;
              cursor: pointer;
            ">Back to Lobby</button>
          </div>
        `;
      }
    }

    // Handle page unload
    window.addEventListener('beforeunload', () => {
      if (client) {
        client.leaveSession();
      }
    });

    // Start initialization
    initializeMultiplayerGame();
  </script>
</body>
</html>
