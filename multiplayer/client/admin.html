<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Multiplayer Admin Panel</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
    }

    .header p {
      opacity: 0.9;
      font-size: 1.1em;
    }

    .section {
      padding: 30px;
      border-bottom: 1px solid #e0e0e0;
    }

    .section:last-child {
      border-bottom: none;
    }

    .section h2 {
      color: #667eea;
      margin-bottom: 20px;
      font-size: 1.8em;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .stat-card h3 {
      font-size: 2.5em;
      margin-bottom: 10px;
    }

    .stat-card p {
      opacity: 0.9;
      font-size: 1.1em;
    }

    .session-list {
      margin-top: 20px;
    }

    .session-item {
      background: #f8f9fa;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 15px;
      transition: all 0.3s;
    }

    .session-item:hover {
      border-color: #667eea;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
    }

    .session-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .session-code {
      font-size: 1.5em;
      font-weight: bold;
      color: #667eea;
    }

    .session-status {
      padding: 5px 15px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 0.9em;
    }

    .status-waiting {
      background: #ffc107;
      color: #000;
    }

    .status-active {
      background: #28a745;
      color: white;
    }

    .status-ended {
      background: #dc3545;
      color: white;
    }

    .session-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 15px;
    }

    .info-item {
      display: flex;
      flex-direction: column;
    }

    .info-label {
      font-size: 0.85em;
      color: #666;
      margin-bottom: 5px;
    }

    .info-value {
      font-weight: bold;
      color: #333;
    }

    .player-list {
      margin-top: 10px;
    }

    .player-chip {
      display: inline-block;
      padding: 5px 12px;
      margin: 5px 5px 5px 0;
      border-radius: 20px;
      font-size: 0.9em;
      font-weight: bold;
      color: white;
    }

    .player-host {
      background: #667eea;
    }

    .player-ready {
      background: #28a745;
    }

    .player-not-ready {
      background: #6c757d;
    }

    .btn-group {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 1em;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .btn-danger {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
    }

    .btn-warning {
      background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
      color: #333;
    }

    .btn-primary {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
    }

    .btn-success {
      background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
      color: white;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: #999;
    }

    .empty-state svg {
      width: 100px;
      height: 100px;
      margin-bottom: 20px;
      opacity: 0.3;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #667eea;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 10px;
      color: white;
      font-weight: bold;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      opacity: 0;
      transform: translateX(400px);
      transition: all 0.3s;
      z-index: 1000;
    }

    .notification.show {
      opacity: 1;
      transform: translateX(0);
    }

    .notification.success {
      background: #28a745;
    }

    .notification.error {
      background: #dc3545;
    }

    .notification.info {
      background: #17a2b8;
    }

    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    .controls button {
      flex: 1;
      min-width: 150px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üéÆ Multiplayer Admin Panel</h1>
      <p>Manage active game sessions and monitor server status</p>
    </div>

    <div class="section">
      <h2>üìä Server Statistics</h2>
      <div class="stats-grid">
        <div class="stat-card">
          <h3 id="activeSessions">0</h3>
          <p>Active Sessions</p>
        </div>
        <div class="stat-card">
          <h3 id="totalPlayers">0</h3>
          <p>Connected Players</p>
        </div>
        <div class="stat-card">
          <h3 id="gamesInProgress">0</h3>
          <p>Games in Progress</p>
        </div>
        <div class="stat-card">
          <h3 id="waitingRooms">0</h3>
          <p>Waiting Rooms</p>
        </div>
      </div>
    </div>

    <div class="section">
      <h2>üéØ Session Management</h2>
      <div class="controls">
        <button class="btn btn-primary" onclick="refreshSessions()">
          üîÑ Refresh Sessions
        </button>
        <button class="btn btn-danger" onclick="endAllSessions()">
          ‚õî End All Sessions
        </button>
        <button class="btn btn-warning" onclick="kickInactivePlayers()">
          üë¢ Kick Inactive Players
        </button>
        <button class="btn btn-success" onclick="exportSessionData()">
          üíæ Export Data
        </button>
        <button class="btn btn-primary" onclick="testConnection()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
          üß™ Test Connection
        </button>
      </div>
      
      <div id="sessionContainer">
        <div class="loading">
          <div class="spinner"></div>
          <p>Loading sessions...</p>
        </div>
      </div>
    </div>
  </div>

  <div id="notification" class="notification"></div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // Connect to server
    console.log('üîß Admin panel initializing...');
    const socket = io();
    let sessions = {};

    // Initialize
    socket.on('connect', () => {
      console.log('‚úÖ Connected to server - Socket ID:', socket.id);
      showNotification('Connected to server', 'success');
      refreshSessions();
    });

    socket.on('disconnect', () => {
      console.log('‚ùå Disconnected from server');
      showNotification('Disconnected from server', 'error');
    });

    socket.on('connect_error', (error) => {
      console.error('‚ùå Connection error:', error);
      showNotification('Connection error: ' + error.message, 'error');
    });

    // Request admin data
    function refreshSessions() {
      console.log('üîÑ Requesting session data...');
      socket.emit('adminGetSessions');
      
      // Show loading state
      const container = document.getElementById('sessionContainer');
      container.innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <p>Loading sessions...</p>
        </div>
      `;
    }

    // Receive session data
    socket.on('adminSessionData', (data) => {
      console.log('üìä Received session data:', data);
      console.log('üìä Number of sessions:', Object.keys(data.sessions || {}).length);
      sessions = data.sessions || {};
      updateUI();
    });

    // Update UI with session data
    function updateUI() {
      console.log('üé® Updating UI with', Object.keys(sessions).length, 'sessions');
      
      // Update stats
      const sessionArray = Object.values(sessions);
      const activeSessions = sessionArray.filter(s => s.status !== 'ended').length;
      const totalPlayers = sessionArray.reduce((sum, s) => sum + (s.players ? Object.keys(s.players).length : 0), 0);
      const gamesInProgress = sessionArray.filter(s => s.status === 'active').length;
      const waitingRooms = sessionArray.filter(s => s.status === 'waiting').length;

      console.log('üìä Stats:', { activeSessions, totalPlayers, gamesInProgress, waitingRooms });

      document.getElementById('activeSessions').textContent = activeSessions;
      document.getElementById('totalPlayers').textContent = totalPlayers;
      document.getElementById('gamesInProgress').textContent = gamesInProgress;
      document.getElementById('waitingRooms').textContent = waitingRooms;

      // Update session list
      const container = document.getElementById('sessionContainer');
      
      if (sessionArray.length === 0) {
        console.log('‚ö†Ô∏è No sessions found');
        container.innerHTML = `
          <div class="empty-state">
            <p style="font-size: 1.5em;">No active sessions</p>
            <p style="margin-top: 10px; color: #999;">Sessions will appear here when players create games</p>
          </div>
        `;
        return;
      }

      console.log('‚úÖ Rendering', sessionArray.length, 'sessions');
      container.innerHTML = '<div class="session-list">' + 
        sessionArray.map(session => renderSession(session)).join('') + 
        '</div>';
    }

    // Render individual session
    function renderSession(session) {
      const players = session.players || {};
      const playerArray = Object.entries(players);
      const statusClass = session.status === 'active' ? 'status-active' : 
                         session.status === 'waiting' ? 'status-waiting' : 'status-ended';
      
      console.log('üé® Rendering session:', session.code || session.sessionCode);
      
      return `
        <div class="session-item">
          <div class="session-header">
            <span class="session-code">${session.code || session.sessionCode || 'N/A'}</span>
            <span class="session-status ${statusClass}">${session.status || 'Unknown'}</span>
          </div>
          
          <div class="session-info">
            <div class="info-item">
              <span class="info-label">Players</span>
              <span class="info-value">${playerArray.length}/${session.maxPlayers || 6}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Host</span>
              <span class="info-value">${session.hostName || 'Unknown'}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Created</span>
              <span class="info-value">${session.createdAt ? new Date(session.createdAt).toLocaleTimeString() : 'N/A'}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Duration</span>
              <span class="info-value">${session.createdAt ? getDuration(session.createdAt) : 'N/A'}</span>
            </div>
          </div>
          
          ${playerArray.length > 0 ? `
            <div class="player-list">
              ${playerArray.map(([name, data]) => `
                <span class="player-chip ${data.isHost ? 'player-host' : data.isReady ? 'player-ready' : 'player-not-ready'}">
                  ${data.isHost ? 'üëë ' : ''}${name}
                </span>
              `).join('')}
            </div>
          ` : ''}
          
          <div class="btn-group">
            <button class="btn btn-danger" onclick="endSession('${session.code || session.sessionCode}')" style="font-size: 1.1em; padding: 12px 24px;">
              ‚õî END THIS SESSION
            </button>
            <button class="btn btn-warning" onclick="viewSessionDetails('${session.code || session.sessionCode}')">
              üìã View Details
            </button>
          </div>
        </div>
      `;
    }

    // End specific session
    function endSession(sessionCode) {
      console.log('‚õî endSession called for:', sessionCode);
      
      if (!confirm(`Are you sure you want to end session ${sessionCode}?`)) {
        console.log('‚ùå User cancelled');
        return;
      }
      
      console.log('‚úÖ User confirmed - Sending adminEndSession event');
      socket.emit('adminEndSession', { sessionCode });
      showNotification(`Ending session ${sessionCode}...`, 'info');
    }

    // End all sessions
    function endAllSessions() {
      const sessionCount = Object.keys(sessions).length;
      console.log('‚õî endAllSessions called - Count:', sessionCount);
      
      if (sessionCount === 0) {
        showNotification('No active sessions to end', 'info');
        return;
      }
      
      if (!confirm(`Are you sure you want to end all ${sessionCount} sessions?`)) {
        console.log('‚ùå User cancelled');
        return;
      }
      
      console.log('‚úÖ User confirmed - Sending adminEndAllSessions event');
      socket.emit('adminEndAllSessions');
      showNotification(`Ending all ${sessionCount} sessions...`, 'info');
    }

    // Kick inactive players
    function kickInactivePlayers() {
      console.log('üë¢ Kicking inactive players...');
      socket.emit('adminKickInactive');
      showNotification('Kicking inactive players...', 'info');
    }

    // Export session data
    function exportSessionData() {
      const dataStr = JSON.stringify(sessions, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `sessions-${new Date().toISOString()}.json`;
      link.click();
      showNotification('Session data exported', 'success');
    }

    // View session details
    function viewSessionDetails(sessionCode) {
      const session = sessions[sessionCode];
      if (!session) {
        showNotification('Session not found', 'error');
        return;
      }
      
      alert(JSON.stringify(session, null, 2));
    }

    // Listen for session ended confirmation
    socket.on('sessionEnded', (data) => {
      console.log('‚úÖ Session ended:', data);
      showNotification(`Session ${data.sessionCode} ended`, 'success');
      refreshSessions();
    });

    // Listen for errors
    socket.on('error', (data) => {
      console.error('‚ùå Server error:', data);
      showNotification('Error: ' + (data.message || 'Unknown error'), 'error');
    });

    // Test connection function
    function testConnection() {
      console.log('üß™ Testing connection...');
      console.log('Socket connected:', socket.connected);
      console.log('Socket ID:', socket.id);
      console.log('Current sessions:', sessions);
      showNotification(`Socket ${socket.connected ? 'connected' : 'disconnected'} - ID: ${socket.id}`, 'info');
      alert(`Connection Test:\n\nConnected: ${socket.connected}\nSocket ID: ${socket.id}\nSessions: ${Object.keys(sessions).length}\n\nCheck console for details (F12)`);
    }

    // Helper: Calculate duration
    function getDuration(createdAt) {
      const now = Date.now();
      const created = new Date(createdAt).getTime();
      const diff = now - created;
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(minutes / 60);
      
      if (hours > 0) {
        return `${hours}h ${minutes % 60}m`;
      }
      return `${minutes}m`;
    }

    // Helper: Show notification
    function showNotification(message, type = 'info') {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.className = `notification ${type} show`;
      
      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }

    // Auto-refresh every 10 seconds
    setInterval(refreshSessions, 10000);
  </script>
</body>
</html>
