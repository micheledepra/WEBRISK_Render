<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Risk - Game Lobby</title>
  <link rel="icon" type="image/x-icon" href="../../favicon.ico">
  <style>
    @font-face {
      font-family: 'Australian';
      src: url('../../res/Font/Australianflyingcorpsstencil-gpR1.ttf') format('truetype');
      font-weight: 300;
      font-style: normal;
      font-display: swap;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Australian', 'Arial', sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #fff;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .lobby-container {
      background: rgba(30, 30, 50, 0.95);
      border: 2px solid #ffd700;
      border-radius: 15px;
      padding: 40px;
      max-width: 800px;
      width: 100%;
      box-shadow: 0 10px 50px rgba(255, 215, 0, 0.3);
    }

    h1 {
      font-size: 2.5em;
      text-align: center;
      margin-bottom: 10px;
      color: #ffd700;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }

    .session-info {
      text-align: center;
      margin-bottom: 30px;
      padding: 15px;
      background: rgba(255, 215, 0, 0.1);
      border-radius: 10px;
    }

    .session-id {
      font-size: 2em;
      color: #ffd700;
      font-weight: bold;
      letter-spacing: 3px;
      margin: 10px 0;
    }

    .share-link {
      margin-top: 10px;
      padding: 10px;
      background: rgba(0,0,0,0.3);
      border-radius: 5px;
      font-size: 0.9em;
    }

    .share-link input {
      background: transparent;
      border: none;
      color: #ffd700;
      width: 100%;
      text-align: center;
      font-family: monospace;
      cursor: pointer;
    }

    .copy-btn {
      margin-top: 10px;
      padding: 8px 20px;
      background: #ffd700;
      color: #1a1a2e;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-family: 'Australian', sans-serif;
      font-size: 0.9em;
      transition: all 0.3s;
    }

    .copy-btn:hover {
      background: #ffed4e;
      transform: scale(1.05);
    }

    .players-section {
      margin: 30px 0;
    }

    .players-section h2 {
      font-size: 1.5em;
      margin-bottom: 20px;
      color: #ffd700;
    }

    .player-list {
      display: grid;
      gap: 15px;
    }

    .player-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 15px 20px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      border: 2px solid transparent;
      transition: all 0.3s;
    }

    .player-item.joined {
      border-color: #4CAF50;
      background: rgba(76, 175, 80, 0.1);
    }

    .player-item.ready {
      border-color: #ffd700;
      background: rgba(255, 215, 0, 0.1);
    }

    .player-item.waiting {
      opacity: 0.5;
    }

    .player-item.you {
      border-color: #2196F3;
      background: rgba(33, 150, 243, 0.1);
    }

    .player-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .player-icon {
      font-size: 1.5em;
    }

    .player-name {
      font-size: 1.2em;
      font-weight: bold;
    }

    .player-status {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.9em;
    }

    .status-badge {
      padding: 5px 15px;
      border-radius: 15px;
      font-size: 0.8em;
      font-weight: bold;
    }

    .status-badge.host {
      background: #ffd700;
      color: #1a1a2e;
    }

    .status-badge.ready {
      background: #4CAF50;
      color: white;
    }

    .status-badge.waiting {
      background: #666;
      color: white;
    }

    .controls {
      margin-top: 30px;
      display: flex;
      gap: 15px;
      justify-content: center;
      flex-wrap: wrap;
    }

    button {
      padding: 15px 40px;
      font-size: 1.2em;
      font-family: 'Australian', sans-serif;
      border: 2px solid #ffd700;
      background: rgba(255, 215, 0, 0.1);
      color: #ffd700;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s;
    }

    button:hover:not(:disabled) {
      background: #ffd700;
      color: #1a1a2e;
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(255, 215, 0, 0.4);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    button.ready-btn {
      background: rgba(76, 175, 80, 0.2);
      border-color: #4CAF50;
      color: #4CAF50;
    }

    button.ready-btn.active {
      background: #4CAF50;
      color: white;
    }

    button.start-btn {
      background: #ffd700;
      color: #1a1a2e;
      font-size: 1.5em;
      padding: 20px 60px;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 25px;
      border-radius: 10px;
      font-weight: bold;
      animation: slideIn 0.3s;
      z-index: 1000;
      max-width: 300px;
    }

    .notification.success {
      background: #4CAF50;
      color: white;
    }

    .notification.error {
      background: #f44336;
      color: white;
    }

    .notification.info {
      background: #2196F3;
      color: white;
    }

    @keyframes slideIn {
      from { transform: translateX(400px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    .loading {
      text-align: center;
      padding: 50px;
    }

    .spinner {
      border: 4px solid rgba(255, 215, 0, 0.3);
      border-top: 4px solid #ffd700;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .back-btn {
      position: absolute;
      top: 20px;
      left: 20px;
      padding: 10px 20px;
      font-size: 1em;
    }

    .connection-status {
      display: flex;
      align-items: center;
      gap: 10px;
      justify-content: center;
      margin-bottom: 20px;
      font-size: 0.9em;
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #4CAF50;
      animation: blink 2s infinite;
    }

    .status-dot.disconnected {
      background: #f44336;
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }
  </style>
</head>
<body>
  <button class="back-btn" onclick="goBack()">‚Üê Back</button>

  <div class="lobby-container" id="lobbyContainer">
    <div class="loading" id="loadingScreen">
      <div class="spinner"></div>
      <p>Connecting to server...</p>
    </div>

    <div id="lobbyContent" style="display: none;">
      <h1>üé≤ Game Lobby</h1>

      <div class="connection-status">
        <div class="status-dot" id="statusDot"></div>
        <span id="statusText">Connected</span>
      </div>

      <div class="session-info">
        <div>Session Code:</div>
        <div class="session-id" id="sessionId">------</div>
        <div class="share-link">
          <input type="text" id="shareLink" readonly onclick="copyLink()">
        </div>
        <button class="copy-btn" onclick="copyLink()">üìã Copy Link</button>
      </div>

      <div class="players-section">
        <h2>Players (<span id="playerCount">0</span>/<span id="maxPlayers">6</span>)</h2>
        <div class="player-list" id="playerList">
          <!-- Players will be populated here -->
        </div>
      </div>

      <div class="controls">
        <button class="ready-btn" id="readyBtn" onclick="toggleReady()">
          Ready Up
        </button>
        <button class="start-btn" id="startBtn" onclick="startGame()" style="display: none;">
          üéÆ Start Game
        </button>
      </div>
    </div>
  </div>

  <!-- Socket.IO Client -->
  <script src="http://localhost:3000/socket.io/socket.io.js"></script>
  <script src="MultiplayerClient.js"></script>
  <script>
    // Get URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const sessionId = urlParams.get('session');
    const action = urlParams.get('action'); // 'create' or 'join'
    const playerName = urlParams.get('name') || localStorage.getItem('risk_playerName') || 'Player';
    const playerCount = parseInt(urlParams.get('count')) || 2;

    // Initialize multiplayer client
    const client = new MultiplayerClient('http://localhost:3000');
    let isHost = false;
    let isReady = false;
    let currentSession = null;

    // Start initialization
    async function init() {
      try {
        await client.connect();

        if (action === 'create') {
          // Create new session
          const result = await client.createSession(playerName, playerCount);
          isHost = true;
          window.history.replaceState({}, '', `?session=${result.sessionId}&action=join&name=${playerName}`);
          await client.joinSession(result.sessionId, playerName);
        } else if (sessionId) {
          // Join existing session
          await client.joinSession(sessionId, playerName);
        } else {
          throw new Error('No session specified');
        }

        setupEventListeners();
        hideLoading();
      } catch (error) {
        console.error('Initialization error:', error);
        showNotification(error.message, 'error');
        setTimeout(() => {
          window.location.href = '../../index.html';
        }, 2000);
      }
    }

    function setupEventListeners() {
      // Session updates
      client.on('onSessionUpdate', (session) => {
        currentSession = session;
        updateLobbyUI(session);
      });

      // Player updates
      client.on('onPlayersUpdate', (data) => {
        if (currentSession) {
          currentSession.players = data.players;
          updatePlayerList(data.players);
          
          if (data.action === 'joined') {
            showNotification(`${data.player.playerName} joined the lobby`, 'success');
          } else if (data.action === 'left') {
            showNotification(`${data.player.playerName} left the lobby`, 'info');
          }
        }
      });

      // Game started
      client.on('onGameStateUpdate', (gameState) => {
        console.log('Game starting!');
        showNotification('Game starting...', 'success');
        
        // Redirect to game page
        setTimeout(() => {
          window.location.href = `multiplayer-game.html?session=${client.sessionId}`;
        }, 1000);
      });

      // Connection status
      client.on('onConnect', () => {
        updateConnectionStatus(true);
      });

      client.on('onDisconnect', () => {
        updateConnectionStatus(false);
        showNotification('Disconnected from server', 'error');
      });

      // Errors
      client.on('onSessionError', (error) => {
        showNotification(error.message, 'error');
      });
    }

    function updateLobbyUI(session) {
      document.getElementById('sessionId').textContent = session.sessionId;
      document.getElementById('playerCount').textContent = session.players.length;
      document.getElementById('maxPlayers').textContent = session.maxPlayers;
      
      const shareLink = `${window.location.origin}${window.location.pathname}?session=${session.sessionId}&action=join`;
      document.getElementById('shareLink').value = shareLink;

      updatePlayerList(session.players);
      updateStartButton(session);
    }

    function updatePlayerList(players) {
      const playerList = document.getElementById('playerList');
      playerList.innerHTML = '';

      players.forEach((player, index) => {
        const playerDiv = document.createElement('div');
        playerDiv.className = 'player-item';
        
        if (player.state === 'ready') {
          playerDiv.classList.add('ready');
        } else {
          playerDiv.classList.add('joined');
        }
        
        if (player.userId === client.userId) {
          playerDiv.classList.add('you');
        }

        const isPlayerHost = currentSession && player.userId === currentSession.hostUserId;

        playerDiv.innerHTML = `
          <div class="player-info">
            <div class="player-icon">üë§</div>
            <div class="player-name">
              ${player.playerName}
              ${player.userId === client.userId ? ' (You)' : ''}
            </div>
          </div>
          <div class="player-status">
            ${isPlayerHost ? '<span class="status-badge host">HOST</span>' : ''}
            <span class="status-badge ${player.state === 'ready' ? 'ready' : 'waiting'}">
              ${player.state === 'ready' ? '‚úì Ready' : 'Waiting...'}
            </span>
          </div>
        `;

        playerList.appendChild(playerDiv);
      });

      // Add empty slots
      if (currentSession) {
        const emptySlots = currentSession.maxPlayers - players.length;
        for (let i = 0; i < emptySlots; i++) {
          const emptyDiv = document.createElement('div');
          emptyDiv.className = 'player-item waiting';
          emptyDiv.innerHTML = `
            <div class="player-info">
              <div class="player-icon">‚è≥</div>
              <div class="player-name">Waiting for player...</div>
            </div>
          `;
          playerList.appendChild(emptyDiv);
        }
      }
    }

    function updateStartButton(session) {
      const startBtn = document.getElementById('startBtn');
      const allReady = session.players.every(p => p.state === 'ready');
      const enoughPlayers = session.players.length >= 2;

      if (isHost && allReady && enoughPlayers) {
        startBtn.style.display = 'block';
        startBtn.disabled = false;
      } else if (isHost) {
        startBtn.style.display = 'block';
        startBtn.disabled = true;
      } else {
        startBtn.style.display = 'none';
      }
    }

    function toggleReady() {
      isReady = !isReady;
      client.setReady(isReady);
      
      const readyBtn = document.getElementById('readyBtn');
      readyBtn.textContent = isReady ? '‚úì Ready' : 'Ready Up';
      readyBtn.classList.toggle('active', isReady);
    }

    function startGame() {
      if (!isHost || !currentSession) return;

      // Create initial game state with player data from session
      const players = currentSession.players.map(p => ({
        name: p.playerName,
        userId: p.userId,
        color: getPlayerColor(p.playerIndex)
      }));

      const initialGameState = {
        players: players,
        currentPlayerIndex: 0,
        phase: 'startup',
        turnNumber: 0,
        territories: {}
      };

      client.startGame(initialGameState);
    }

    function getPlayerColor(index) {
      const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8', '#F7DC6F'];
      return colors[index % colors.length];
    }

    function copyLink() {
      const input = document.getElementById('shareLink');
      input.select();
      document.execCommand('copy');
      showNotification('Link copied to clipboard!', 'success');
    }

    function goBack() {
      if (confirm('Are you sure you want to leave the lobby?')) {
        client.leaveSession();
        window.location.href = '../../index.html';
      }
    }

    function updateConnectionStatus(connected) {
      const dot = document.getElementById('statusDot');
      const text = document.getElementById('statusText');
      
      if (connected) {
        dot.classList.remove('disconnected');
        text.textContent = 'Connected';
      } else {
        dot.classList.add('disconnected');
        text.textContent = 'Disconnected';
      }
    }

    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      document.body.appendChild(notification);

      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    function hideLoading() {
      document.getElementById('loadingScreen').style.display = 'none';
      document.getElementById('lobbyContent').style.display = 'block';
    }

    // Handle page unload
    window.addEventListener('beforeunload', () => {
      client.leaveSession();
    });

    // Initialize
    init();
  </script>
</body>
</html>
